#!/bin/bash

VENV_HOME=".venv"
PYTHON_HOME="$VENV_HOME/bin"
PYTHON_RECOMMENDED_VERSION="3.10.6"
MODELS_HOME="$(dirname "$0")/models"
LOGGING_PREFIX="\033[90m[\033[33mCoolCLK\033[90m/\033[36mturn-live-photos\033[90m] \033[0m"

end() {
    echo -e "${LOGGING_PREFIX}å…³é—­è„šæœ¬ä¸­"
    exit 0
}

check_python() {
    if ! command -v python &> /dev/null; then
        echo -e "${LOGGING_PREFIX}æœªæ£€æµ‹åˆ° Python ç¯å¢ƒ"
        exit
    fi

    PYTHON_VERSION=$(python --version 2>&1 | awk '{print $2}')
    if [[ "$PYTHON_VERSION" != "3.10.6" ]]; then
        echo -e "${LOGGING_PREFIX}è­¦å‘Šï¼šæ£€æµ‹åˆ°ä¸æ”¯æŒçš„ Python ç‰ˆæœ¬ $PYTHON_VERSION"
        echo -e "${LOGGING_PREFIX}æˆ‘ä»¬æ¨èä½¿ç”¨ Python ${PYTHON_RECOMMENDED_VERSION}"
        echo -e "${LOGGING_PREFIX}è¯¦è§ https://www.python.org/downloads/release/python-3106/"
    fi
}

activate_venv() {
    if [[ ! -d "$VENV_HOME" ]]; then
        echo -e "${LOGGING_PREFIX}æ­£åœ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒä¸­"
        python -m venv "$VENV_HOME"
        echo -e "${LOGGING_PREFIX}åœ¨ $VENV_HOME ç›®å½•åˆ›å»ºäº†è™šæ‹Ÿç¯å¢ƒ"
    fi

    echo -e "${LOGGING_PREFIX}æ¿€æ´»è™šæ‹Ÿç¯å¢ƒä¸­..."
    source "$VENV_HOME/Scripts/activate"
}

install_dependencies() {
    read -p "${LOGGING_PREFIX}æ˜¯å¦æ£€æŸ¥ä¾èµ– (Y/n) " DO_CHECK
    if [[ "$DO_CHECK" =~ ^[Yy]$ ]] || [[ -z "$DO_CHECK" ]]; then
        echo -e "${LOGGING_PREFIX}ä» requirements.txt å¤„ç†ä¾èµ–ä¸­[31m"
        echo -e "[31m"
        pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple > /dev/null 2>&1
        pip install torch==2.7.0+cu128 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128 > /dev/null 2>&1
        pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple > /dev/null 2>&1
        echo -e "[0m"
    fi
}

pretrained_model_downloading() {
    read -p "${LOGGING_PREFIX}æ˜¯å¦æå‰ä¸‹è½½/æ›´æ–°æ¨¡å‹ (Y/n) " DO_DOWNLOAD
    if [[ "$DO_DOWNLOAD" =~ ^[Yy]$ ]] || [[ -z "$DO_DOWNLOAD" ]]; then
        if ! command -v git &> /dev/null; then
            echo -e "${LOGGING_PREFIX}æ£€æµ‹åˆ°æœªå®‰è£… Gitï¼ˆhttps://git-scm.com/ï¼‰ï¼Œæ­£åœ¨è·³è¿‡..."
            return
        fi

        MODEL_URL="https://huggingface.co/stabilityai/stable-video-diffusion-img2vid-xt"
        read -p "${LOGGING_PREFIX}æ˜¯å¦ä½¿ç”¨ hf-mirror.com é•œåƒ (Y/n) " USE_MIRROR
        if [[ "$USE_MIRROR" =~ ^[Yy]$ ]]; then
            MODEL_URL="https://hf-mirror.com/stabilityai/stable-video-diffusion-img2vid-xt"
        fi

        echo -e "${LOGGING_PREFIX}æˆ‘ä»¬é»˜è®¤ä½ å·²å®‰è£… Git LFSï¼ˆhttps://git-lfs.com/ï¼‰"
        git lfs install --force > /dev/null 2>&1

        MODEL_DIR="${MODELS_HOME}stabilityai/stable-video-diffusion-img2vid-xt"
        if [[ -d "$MODEL_DIR" ]]; then
            echo -e "${LOGGING_PREFIX}å¼€å§‹æ‹‰å– stabilityai/stable-video-diffusion-img2vid-xt ..."
            git -C "$MODEL_DIR" pull > /dev/null 2>&1
        else
            echo -e "${LOGGING_PREFIX}å¼€å§‹å…‹éš† stabilityai/stable-video-diffusion-img2vid-xt ..."
            git clone "$MODEL_URL" "$MODEL_DIR" > /dev/null 2>&1
        fi
}

run_script() {
    echo -e "${LOGGING_PREFIX}ä»¥ $(cat run_args.txt) çš„å‚æ•°å¯åŠ¨ Python è„šæœ¬"
    python app.py $(cat run_args.txt)
    echo -e "${LOGGING_PREFIX}Python è„šæœ¬å·²åœæ­¢"
}

deactivate_venv() {
    echo -e "${LOGGING_PREFIX}åœç”¨è™šæ‹Ÿç¯å¢ƒä¸­"
    source "$VENV_HOME/Scripts/deactivate"
}

check_python
activate_venv
install_dependencies
pretrained_model_downloading
run_script
deactivate_venv
exit